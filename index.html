<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Restaurant Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:0;padding:1rem;background:#f5f7fa;color:#333}
    h1{text-align:center;margin-top:0}
    .controls{display:flex;flex-wrap:wrap;gap:.6rem;margin-bottom:1rem;background:#fff;padding:1rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .controls label{display:flex;flex-direction:column;font-size:.9rem}
    select,input{padding:.4rem;border:1px solid #bbb;border-radius:4px}
    button{background:#1976d2;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer}
    button:hover{background:#1565c0}
    #stats{margin-bottom:.5rem;font-weight:500}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    th,td{padding:.6rem;text-align:left}
    th{background:#1976d2;color:#fff}
    tr:nth-child(even){background:#f2f2f2}
    a{color:#1976d2;text-decoration:none}
    a:hover{text-decoration:underline}
    @media(max-width:700px){body{padding:.5rem} .controls{flex-direction:column}}
  </style>
</head>
<body>
  <h1>Restaurant Dashboard</h1>
  <div id="msg">Loading data …</div>

  <div class="controls">
    <label>Restaurant
      <select id="restFilter"><option>All</option></select>
    </label>

    <label>Year
      <select id="yearFilter"><option>All</option></select>
    </label>

    <label>Avg spend ≥
      <input type="number" id="avgMin" step="0.01" placeholder="0">
    </label>
    <label>Avg spend ≤
      <input type="number" id="avgMax" step="0.01">
    </label>

    <label>Total spend ≥
      <input type="number" id="totMin" step="0.01">
    </label>
    <label>Total spend ≤
      <input type="number" id="totMax" step="0.01">
    </label>

    <label>Days since last order ≥
      <input type="number" id="lastMin" placeholder="0">
    </label>
    <label>Days since last order ≤
      <input type="number" id="lastMax">
    </label>

    <label><input type="checkbox" id="lostOnly"> Lost customers only (90+ days)</label>
    <button id="applyBtn">Apply filters</button>
  </div>

  <div id="stats"></div>

  <table id="mainTable">
    <thead>
      <tr>
        <th>Phone</th><th>Account Name</th><th>Orders</th><th>Total</th><th>Avg</th><th>Last order</th><th>Days ago</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const DATA_URL = 'https://raw.githubusercontent.com/aladdinswelam-byte/customer-dashboard/main/data.json';

    let rawRows=[], aggPhones=[], uniqueOptions={};
    const today=new Date();

    document.getElementById('applyBtn').addEventListener('click', applyAllFilters);

    fetch(DATA_URL,{cache:'no-cache',mode:'cors'})
      .then(r=>r.json())
      .then(js=>{
        rawRows=js;
        localStorage.setItem('dashboardJSON', JSON.stringify(rawRows)); // for detail page
        buildFilters();
        aggregateByPhone();
        applyAllFilters();
        document.getElementById('msg').style.display='none';
      })
      .catch(err=>{
        document.getElementById('msg').textContent='Error: '+err.message;
        console.error(err);
      });

    function buildFilters(){
      const rests=['All', ...new Set(rawRows.map(r=>r['Resturant']||r['Restaurant']||'').filter(v=>v))].sort();
      const years=['All', ...new Set(rawRows.map(r=>{
        const d=new Date(r['Created']||r['OrderDate']||r['Created Date']||'');
        return d.getFullYear();
      }).filter(y=>!isNaN(y)))].sort((a,b)=>b-a);

      document.getElementById('restFilter').innerHTML=rests.map(v=>`<option>${v}</option>`).join('');
      document.getElementById('yearFilter').innerHTML=years.map(v=>`<option>${v}</option>`).join('');
    }

    function aggregateByPhone(){
      const map={};
      rawRows.forEach(r=>{
        const ph=(r['Account Phones']||r['Phone']||'').toString().trim();
        if(!ph) return;
        if(!map[ph]) map[ph]={phone:ph, name:r['Account Name']||'', orders:[], total:0};
        const val=parseFloat(r['Total Price'])||0;
        map[ph].orders.push({
          date:new Date(r['Created']||r['OrderDate']||r['Created Date']||''),
          rest:r['Resturant']||r['Restaurant']||'',
          pay:r['Payment Method']||'',
          value:val
        });
        map[ph].total+=val;
      });
      aggPhones=Object.values(map).map(x=>{
        x.orders.sort((a,b)=>a.date-b.date);
        const last=x.orders[x.orders.length-1].date;
        const days=Math.floor((today-last)/864e5);
        return{
          phone:x.phone,
          name:x.name,
          orders:x.orders.length,
          total:x.total,
          avg:x.total/x.orders.length,
          lastOrder:last,
          daysAgo:days,
          year:last.getFullYear(),
          orderList:x.orders
        };
      });
    }

    function applyAllFilters(){
      let list=[...aggPhones];
      const restSel=document.getElementById('restFilter').value;
      const yearSel=document.getElementById('yearFilter').value;
      if(restSel!=='All') list=list.filter(p=>p.orderList.some(o=>o.rest===restSel));
      if(yearSel!=='All') list=list.filter(p=>p.year===parseInt(yearSel));

      const avgMin=parseFloat(document.getElementById('avgMin').value)||0;
      const avgMax=parseFloat(document.getElementById('avgMax').value)||Infinity;
      const totMin=parseFloat(document.getElementById('totMin').value)||0;
      const totMax=parseFloat(document.getElementById('totMax').value)||Infinity;
      const lastMin=parseInt(document.getElementById('lastMin').value)||0;
      const lastMax=parseInt(document.getElementById('lastMax').value)||Infinity;
      const lostOnly=document.getElementById('lostOnly').checked;

      list=list.filter(p=>
        p.avg>=avgMin && p.avg<=avgMax &&
        p.total>=totMin && p.total<=totMax &&
        p.daysAgo>=lastMin && p.daysAgo<=lastMax &&
        (!lostOnly || p.daysAgo>90)
      );
      list.sort((a,b)=>b.orders-a.orders);
      drawTable(list);
    }

    function drawTable(list){
      const tb=document.querySelector('#mainTable tbody');
      tb.innerHTML='';
      list.forEach(p=>{
        const row=document.createElement('tr');
        row.innerHTML=`
          <td><a href="details.html?phone=${encodeURIComponent(p.phone)}" target="_blank">${p.phone}</a></td>
          <td>${p.name}</td>
          <td>${p.orders}</td>
          <td>${p.total.toFixed(2)}</td>
          <td>${p.avg.toFixed(2)}</td>
          <td>${p.lastOrder.toLocaleDateString()}</td>
          <td>${p.daysAgo}</td>`;
        tb.appendChild(row);
      });
      document.getElementById('stats').textContent=`Showing ${list.length} phones`;
    }
  </script>
</body>
</html>
